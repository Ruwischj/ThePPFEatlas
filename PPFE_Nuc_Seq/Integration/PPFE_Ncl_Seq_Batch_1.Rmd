---
title: "PPFE"
author: "Jannik Ruwisch"
date: "2024-02-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T,
                      fig.width = 14,
                      fig.height = 7,
                      dpi = 300,
                      dev = "png",
                      cache = F)
```


# INFO
```{r}
# INfos
## Dataset was created with 10X Flex Tech >> Lower UMIs, Features and Counts than Xenium ! 
```

# Packages
```{r}
library(SCP)
library(Seurat)
library(SeuratObject)
library(dplyr)
library(tidyverse)
library(tidyseurat)
library(viridis)
library(RColorBrewer)
library(scales)
library(circlize)
library(monocle3)
library(ComplexHeatmap)
library(cowplot)
```


# Load 10X FLEX Dataset
```{r}
PPFE_raw <- load("./PPFE.CTRL.merged.20022024.Robj") # Batch 1 Aligned Data
PPFE_raw <- UpdateSeuratObject(CLAD.PPFE.obj)
rm(CLAD.PPFE.obj)
Version(PPFE_raw)
PPFE_raw@meta.data$orig.ident %>% unique()
PPFE_raw <- PPFE_raw %>%
  mutate(disease.ident = substr(PPFE_raw$orig.ident, 1,4)
         )
```

#=============
# Data Cleaning
```{r}
# Calculate MTs
PPFE_raw[["percent.mt"]] <- PercentageFeatureSet(PPFE_raw, pattern = "^MT-", assay = "RNA")

# Get a List of all samples 
PPFE.list <- SplitObject(PPFE_raw, split.by = "orig.ident")

PPFE_raw@meta.data %>%
  filter(disease.ident == "PPFE") %>%
  pull(orig.ident) %>%
  unique()

PPFE_raw@meta.data %>%
  filter(disease.ident == "CTRL") %>%
  pull(orig.ident) %>%
  unique()

# Create Metadata Dataframe
PPFE_metadata <- PPFE_raw[[]]
```

#=============

# Assess QC-Metrics for each Sample

## Pipeline-Function
```{r}
thePipeline <- function(sample.name,min.counts,min.features,max.mt,tag, seurat.data){
  
  set.seed(123)
  
  # Create directory named after sample.name if it does not exist
  dir.create(file.path(getwd(), sample.name), showWarnings = FALSE)
  
  # Base path for saving files
  base_save_path <- file.path(getwd(), sample.name)
  # Plot QC metrics
  QCViolinPlotter(sample.name=sample.name,min.counts=min.counts,min.features=min.features,max.mt=max.mt,tag=tag, base_save_path=base_save_path)
  TriplePercentMtPlotter(sample.name=sample.name,min.counts=min.counts,min.features=min.features,max.mt=max.mt,tag=tag, base_save_path=base_save_path)
  # Pull object, apply subset, & dimensional reduction
  x <- which(sample.name == names(seurat.data))
  object <- seurat.data[[x]]
  object <- subset(object, nCount_RNA > min.counts & nFeature_RNA > min.features & percent.mt < max.mt)
  object <- NormalizeData(object)
  object <- FindVariableFeatures(object)
  object <- ScaleData(object) # don't regress on anything for now, see if it matters
  object <- RunPCA(object, npcs = 50, verbose = F)
  png(file.path(base_save_path, paste(sample.name,tag, '_elbow.png',sep="")), width = 800, height = 500)
  print(ElbowPlot(object,ndims = 50)+labs(title = sample.name))
  dev.off()
  pdf(file.path(base_save_path, paste(sample.name,'_pcheatmap_1',tag,'.pdf',sep="")), width = 12, height = 16)
  print(DimHeatmap(object, dims = 1:15, cells = 200, balanced = T))
  dev.off()
  pdf(file.path(base_save_path, paste(sample.name,'_pcheatmap_2',tag,'.pdf',sep="")), width = 12, height = 16)
  print(DimHeatmap(object, dims = 16:30, cells = 200, balanced = T))
  dev.off()
  
  # Cluster, plot, & check QC
  pcs <- 30
  object <- FindNeighbors(object, dims = 1:pcs)
  object <- FindClusters(object, resolution = 0.5)
  object <- RunUMAP(object, reduction = "pca", dims = 1:pcs)
  png(file.path(base_save_path, paste(sample.name,'_umap_1',tag,'.png',sep="")), width = 500, height = 500)
  print(UMAPPlot(object,label = T) + labs(title = sample.name,subtitle = paste("PC's = ",pcs)) + NoLegend() + NoAxes())
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_fp_lin',tag,'.png',sep="")), width = 800, height = 800)
  print(FeaturePlot(object, c('CDH5','COL1A1','EPCAM','PTPRC'), label = T,repel=T))
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_fp_qc',tag,'.png',sep="")), width = 800, height = 1200)
  print(FeaturePlot(object, c('percent.mt','nCount_RNA','nFeature_RNA','MKI67','TOP2A'),ncol=2,label = T,repel=T))
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_vln_lin',tag,'.png',sep="")), width = 800, height = 800)
  print(VlnPlot(object, c('CDH5','COL1A1','EPCAM','PTPRC'),ncol=2,pt.size=0.1))
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_vln_qc',tag,'.png',sep="")), width = 800, height = 800)
  print(VlnPlot(object, c('percent.mt','nCount_RNA','nFeature_RNA','MKI67','TOP2A'),ncol=2,pt.size=0.1))
  dev.off()
  
  ## Backtrack to original Filtration plots
  nclusters <- length(levels(object$seurat_clusters))
  # ViolinPlots broken apart by cluster
  p <- VlnPlot(object, features = c("nCount_RNA"),pt.size=0.1,log=T) +
    geom_hline(yintercept=min.counts, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Min.Counts = ",min.counts)) + theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  q <- VlnPlot(object, features = c("nFeature_RNA"),pt.size=0.1,log=T) +
    geom_hline(yintercept=min.features, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Min.Features = ",min.features)) + theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  r <- VlnPlot(object, features = c("percent.mt"),pt.size=0.1,y.max=(max.mt+0.5)) +
    geom_hline(yintercept=max.mt, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Max.Mt = ",max.mt)) +
    theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'),plot.caption = element_text(color='red'))
  png(file.path(base_save_path, paste(sample.name,'_filterback_1',tag,'.png',sep="")),width = 1500,height=500)
  print(plot_grid(p,q,r,ncol=3))
  dev.off()
  
  # ViolinPlots not broken apart, jitter points colored by cluster
  p <- VlnPlot(object, features = c("nCount_RNA"),pt.size=0,log=T,group.by='orig.ident',cols=1) +
    geom_jitter(aes(color = factor(object$seurat_clusters)), size = 0.5) +
    scale_colour_manual(name="color", values=hue_pal()(nclusters)) +
    geom_hline(yintercept=min.counts, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Min.Counts = ",min.counts)) + theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  q <- VlnPlot(object, features = c("nFeature_RNA"),pt.size=0,log=T,group.by='orig.ident',cols=1) +
    geom_jitter(aes(color = factor(object$seurat_clusters)), size = 0.5) +
    scale_colour_manual(name="color", values=hue_pal()(nclusters)) +
    geom_hline(yintercept=min.features, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Min.Features = ",min.features)) + theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  r <- VlnPlot(object, features = c("percent.mt"),pt.size=0,group.by='orig.ident',cols=1,y.max=(max.mt+0.5)) +
    geom_jitter(aes(color = factor(object$seurat_clusters)), size = 0.5) +
    scale_colour_manual(name="color", values=hue_pal()(nclusters)) +
    geom_hline(yintercept=max.mt, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Max.Mt = ",max.mt)) +
    theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  png(file.path(base_save_path, paste(sample.name,'_filterback_2',tag,'.png',sep="")),width = 1500,height=500)
  print(plot_grid(p,q,r,ncol=3))
  dev.off()
  
  # Scatter Plot colored by cluster
  list <- subset(PPFE_metadata,orig.ident %in% sample.name)
  filtered <- subset(list,nCount_RNA > min.counts & nFeature_RNA > min.features & percent.mt < max.mt)
  
  png(file.path(base_save_path, paste(sample.name,'_filterback_3',tag,'.png',sep="")),width = 600,height=500)
  print(
    ggplot() +
      geom_point(data=filtered, aes(x=nCount_RNA, y=nFeature_RNA, color=factor(object$seurat_clusters)), size = 0.5) +
      scale_colour_manual(name="color", values=hue_pal()(nclusters)) +
      geom_vline(xintercept=min.counts, linetype='dashed', color='red', size=1) +
      geom_hline(yintercept=min.features, linetype='dashed', color='red', size=1) +
      labs(title = sample.name) +
      labs(subtitle = paste("Min.Counts = ",min.counts," / Min.Features = ",min.features," / Max.Mt = ",max.mt)) +
      theme(plot.title = element_text(size = 24, hjust = 0.5),
            plot.subtitle = element_text(color='red'),
            plot.caption = element_text(color='red'),
            axis.title.x = element_text(size = 20,color='black'),
            axis.title.y = element_text(size = 20,color='black'),
            axis.text.x = element_text(size=12,color='black'),
            axis.text.y = element_text(size = 12,color='black'),
            axis.line = element_line(size = 1),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank())
  )
  dev.off()
  
  # Ribosomal Characterization
  object[['percent.ribo']] <- PercentageFeatureSet(object, pattern = c("RP[SL]\\d+\\w{0,1}\\d*$", 
                                                                       "Rp[sl]\\d+\\w{0,1}\\d*$", 
                                                                       "rp[sl]\\d+\\w{0,1}\\d*$")
                                                   )
  png(file.path(base_save_path, paste(sample.name,'_fp_ribo',tag,'.png',sep="")), width = 500, height = 500)
  print(FeaturePlot(object, c('percent.ribo'), label = T))
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_vln_ribo',tag,'.png',sep="")), width = 500, height = 500)
  print(VlnPlot(object, c('percent.ribo'),pt.size=0.1))
  dev.off()
  
  # Epithelial Characterization
  png(file.path(base_save_path, paste(sample.name,'_fp_c5',tag,'.png',sep="")), width = 800, height = 800)
  print(FeaturePlot(object, c('SFTPC','AGER','DEFB4','LYZ2'), label = T, repel = T))
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_fp_epi',tag,'.png',sep="")), width = 800, height = 800)
  print(FeaturePlot(object, c('KRT5','SFTPC','HOPX','AQP5'), label = T, repel = T))
  dev.off()
  
  ###### Add further Plots outside the original function ######
  # Titration
  count.test <- seq(100, 1000, by = 100)
  for (i in 1:length(count.test)){
    titrationUMAP(object=object,min.counts=count.test[i],min.features=min.features,max.mt=max.mt, base_save_path=base_save_path, sample.name=sample.name)
  }
  feature.test <- seq(100, 1000, by = 100)
  for (i in 1:length(feature.test)){
    titrationUMAP(object=object,min.counts=min.counts,min.features=feature.test[i],max.mt=max.mt, base_save_path=base_save_path, sample.name=sample.name)
  }
  mt.test <- seq(20, 2, by = -2)
  for (i in 1:length(mt.test)){
    titrationUMAP(object=object,min.counts=min.counts,min.features=min.features,max.mt=mt.test[i], base_save_path=base_save_path, sample.name=sample.name)
  }
 
}
```

```{r}
QCViolinPlotter <- function(sample.name,min.counts,min.features,max.mt,tag, base_save_path){
  x <- which(sample.name == names(PPFE.list))
  object <- PPFE.list[[x]]
  filtered <- subset(object,nFeature_RNA > min.features & nCount_RNA > min.counts & percent.mt < max.mt)
  p <- VlnPlot(object, features = c("nCount_RNA"),pt.size=0.1,log=T) +
    geom_hline(yintercept=min.counts, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Min.Counts = ",min.counts)) + theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  q <- VlnPlot(object, features = c("nFeature_RNA"),pt.size=0.1,log=T) +
    geom_hline(yintercept=min.features, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Min.Features = ",min.features)) + theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  r <- VlnPlot(object, features = c("percent.mt"),pt.size=0.1,y.max=50) +
    geom_hline(yintercept=max.mt, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Max.Mt = ",max.mt)) +
    labs(caption = paste("Barcodes retained with these filters from starting total: ",ncol(filtered),"/",ncol(object))) +
    theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'),plot.caption = element_text(color='red'))
  png(file.path(base_save_path, paste(sample.name,'_filterselect_1',tag,'.png',sep="")),width = 1500,height=500)
  print(plot_grid(p,q,r,ncol=3))
  dev.off()
}
```


```{r}
TriplePercentMtPlotter <- function(sample.name,min.counts,min.features,max.mt,tag, base_save_path=base_save_path){
  object <- subset(PPFE_metadata,orig.ident %in% sample.name)
  lowpass <- subset(object,percent.mt < max.mt)
  highmt <- subset(object,percent.mt > max.mt)
  filtered <- subset(object,nFeature_RNA > min.features & nCount_RNA > min.counts & percent.mt < max.mt)
  p <- ggplot() +
    geom_point(data=highmt, aes(x=nCount_RNA, y=nFeature_RNA), color = 'gray') +
    geom_point(data=lowpass, aes(x=nCount_RNA, y=nFeature_RNA, color=percent.mt)) +
    scale_color_viridis(limits = c(0, 50), oob = scales::squish) +
    geom_vline(xintercept=min.counts, linetype='dashed', color='red', size=1) +
    geom_hline(yintercept=min.features, linetype='dashed', color='red', size=1) +
    labs(title = sample.name) +
    labs(subtitle = paste("Min.Counts = ",min.counts," / Min.Features = ",min.features," / Max.Mt = ",max.mt)) +
    labs(caption = paste("Barcodes retained with these filters from starting total: ",nrow(filtered),"/",nrow(object))) +
    theme(plot.title = element_text(size = 24, hjust = 0.5),
          plot.subtitle = element_text(color='red'),
          plot.caption = element_text(color='red'),
          axis.title.x = element_text(size = 20,color='black'),
          axis.title.y = element_text(size = 20,color='black'),
          axis.text.x = element_text(size=12,color='black'),
          axis.text.y = element_text(size = 12,color='black'),
          axis.line = element_line(size = 1),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())
  png(file.path(base_save_path, paste(sample.name,'_filterselect_2',tag,'.png',sep="")),width = 600,height=500)
  print(p)
  dev.off()
}
```

```{r}
titrationUMAP <- function(object,min.counts,min.features,max.mt, base_save_path=base_save_path, sample.name=sample.name){
  object@meta.data$Passing <- 'NoPass'
  cells.Pass <- WhichCells(object,expression = nCount_RNA > min.counts & nFeature_RNA > min.features & percent.mt < max.mt)
  meta.data.pass <- data.frame(Barcode = cells.Pass,Passing = 'Pass')
  rownames(meta.data.pass) <- cells.Pass
  if(length(cells.Pass) < ncol(object)){
    cells.NoPass <- WhichCells(object,cells = cells.Pass,invert = T)
    meta.data.nopass <- data.frame(Barcode = cells.NoPass,Passing = 'NoPass')
    rownames(meta.data.nopass) <- cells.NoPass
  }else{meta.data.nopass <- data.frame()}
  meta.data <- rbind(meta.data.pass,meta.data.nopass)
  object <- AddMetaData(object,metadata = meta.data)
  tag <- paste('min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')
  png(file.path(base_save_path, paste(sample.name,'_TitrationDimPlot.',tag,'.png',sep="")), width = 500, height = 500)
  print(DimPlot(object,group.by = 'Passing',cols = c('#0529F4','#F42F05'),shuffle = T)
        + labs(title = sample.name,subtitle = paste('nCount_RNA >',min.counts,'& nFeature_RNA >',min.features,'& percent.mt <',max.mt)))
  dev.off()
}
```

## Final Cleaning Pipeline-Function
```{r}
thePipeline_final <- function(sample.name,min.counts,min.features,max.mt,tag, seurat.data){
  
  set.seed(123)
  
  # Create directory named after sample.name if it does not exist
  dir.create(file.path(getwd(),paste0("final_",sample.name)), showWarnings = FALSE)
  
  # Base path for saving files
  base_save_path <- file.path(getwd(), paste0("final_",sample.name))
  # Plot QC metrics
  QCViolinPlotter(sample.name=sample.name,min.counts=min.counts,min.features=min.features,max.mt=max.mt,tag=tag, base_save_path=base_save_path)
  TriplePercentMtPlotter(sample.name=sample.name,min.counts=min.counts,min.features=min.features,max.mt=max.mt,tag=tag, base_save_path=base_save_path)
  #TriplePercentSplPlotter(sample.name=sample.name,min.counts=min.counts,min.features=min.features,max.mt=max.mt,tag=tag) <- Haben wir keine Informationen drÃ¼ber bisher
  
  # Pull object, apply subset, & dimensional reduction
  x <- which(sample.name == names(seurat.data))
  object <- seurat.data[[x]]
  #object <- subset(object, nCount_RNA > min.counts & nFeature_RNA > min.features & percent.mt < max.mt)
  object <- NormalizeData(object)
  object <- FindVariableFeatures(object)
  object <- ScaleData(object) # don't regress on anything for now, see if it matters
  object <- RunPCA(object, npcs = 50, verbose = F)
  png(file.path(base_save_path, paste(sample.name,tag, '_elbow.png',sep="")), width = 800, height = 500)
  print(ElbowPlot(object,ndims = 50)+labs(title = sample.name))
  dev.off()
  pdf(file.path(base_save_path, paste(sample.name,'_pcheatmap_1',tag,'.pdf',sep="")), width = 12, height = 16)
  print(DimHeatmap(object, dims = 1:15, cells = 200, balanced = T))
  dev.off()
  pdf(file.path(base_save_path, paste(sample.name,'_pcheatmap_2',tag,'.pdf',sep="")), width = 12, height = 16)
  print(DimHeatmap(object, dims = 16:30, cells = 200, balanced = T))
  dev.off()
  
  # Cluster, plot, & check QC
  pcs <- 30
  object <- FindNeighbors(object, dims = 1:pcs)
  object <- FindClusters(object, resolution = 0.5)
  object <- RunUMAP(object, reduction = "pca", dims = 1:pcs)
  png(file.path(base_save_path, paste(sample.name,'_umap_1',tag,'.png',sep="")), width = 500, height = 500)
  print(UMAPPlot(object,label = T) + labs(title = sample.name,subtitle = paste("PC's = ",pcs)) + NoLegend() + NoAxes())
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_fp_lin',tag,'.png',sep="")), width = 800, height = 800)
  print(FeaturePlot(object, c('CDH5','COL1A1','EPCAM','PTPRC'), label = T,repel=T))
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_fp_qc',tag,'.png',sep="")), width = 800, height = 1200)
  print(FeaturePlot(object, c('percent.mt','nCount_RNA','nFeature_RNA','MKI67','TOP2A'),ncol=2,label = T,repel=T))
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_vln_lin',tag,'.png',sep="")), width = 800, height = 800)
  print(VlnPlot(object, c('CDH5','COL1A1','EPCAM','PTPRC'),ncol=2,pt.size=0.1))
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_vln_qc',tag,'.png',sep="")), width = 800, height = 800)
  print(VlnPlot(object, c('percent.mt','nCount_RNA','nFeature_RNA','MKI67','TOP2A'),ncol=2,pt.size=0.1))
  dev.off()
  
  ## Backtrack to original Filtration plots
  nclusters <- length(levels(object$seurat_clusters))
  # ViolinPlots broken apart by cluster
  p <- VlnPlot(object, features = c("nCount_RNA"),pt.size=0.1,log=T) +
    geom_hline(yintercept=min.counts, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Min.Counts = ",min.counts)) + theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  q <- VlnPlot(object, features = c("nFeature_RNA"),pt.size=0.1,log=T) +
    geom_hline(yintercept=min.features, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Min.Features = ",min.features)) + theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  r <- VlnPlot(object, features = c("percent.mt"),pt.size=0.1,y.max=(max.mt+0.5)) +
    geom_hline(yintercept=max.mt, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Max.Mt = ",max.mt)) +
    theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'),plot.caption = element_text(color='red'))
  png(file.path(base_save_path, paste(sample.name,'_filterback_1',tag,'.png',sep="")),width = 1500,height=500)
  print(plot_grid(p,q,r,ncol=3))
  dev.off()
  
  # ViolinPlots not broken apart, jitter points colored by cluster
  p <- VlnPlot(object, features = c("nCount_RNA"),pt.size=0,log=T,group.by='orig.ident',cols=1) +
    geom_jitter(aes(color = factor(object$seurat_clusters)), size = 0.5) +
    scale_colour_manual(name="color", values=hue_pal()(nclusters)) +
    geom_hline(yintercept=min.counts, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Min.Counts = ",min.counts)) + theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  q <- VlnPlot(object, features = c("nFeature_RNA"),pt.size=0,log=T,group.by='orig.ident',cols=1) +
    geom_jitter(aes(color = factor(object$seurat_clusters)), size = 0.5) +
    scale_colour_manual(name="color", values=hue_pal()(nclusters)) +
    geom_hline(yintercept=min.features, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Min.Features = ",min.features)) + theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  r <- VlnPlot(object, features = c("percent.mt"),pt.size=0,group.by='orig.ident',cols=1,y.max=(max.mt+0.5)) +
    geom_jitter(aes(color = factor(object$seurat_clusters)), size = 0.5) +
    scale_colour_manual(name="color", values=hue_pal()(nclusters)) +
    geom_hline(yintercept=max.mt, linetype='dashed', color='red', size=1) +
    labs(subtitle = paste("Max.Mt = ",max.mt)) +
    theme(legend.position = 'none',axis.title.x = element_blank(),plot.subtitle = element_text(color='red'))
  png(file.path(base_save_path, paste(sample.name,'_filterback_2',tag,'.png',sep="")),width = 1500,height=500)
  print(plot_grid(p,q,r,ncol=3))
  dev.off()
  
  # Scatter Plot colored by cluster
  list <- subset(PPFE_metadata,orig.ident %in% sample.name)
  filtered <- list#subset(list,nCount_RNA > min.counts & nFeature_RNA > min.features & percent.mt < max.mt)
  
  png(file.path(base_save_path, paste(sample.name,'_filterback_3',tag,'.png',sep="")),width = 600,height=500)
  print(
    ggplot() +
      geom_point(data=filtered, aes(x=nCount_RNA, y=nFeature_RNA, color=factor(object$seurat_clusters)), size = 0.5) +
      scale_colour_manual(name="color", values=hue_pal()(nclusters)) +
      geom_vline(xintercept=min.counts, linetype='dashed', color='red', size=1) +
      geom_hline(yintercept=min.features, linetype='dashed', color='red', size=1) +
      labs(title = sample.name) +
      labs(subtitle = paste("Min.Counts = ",min.counts," / Min.Features = ",min.features," / Max.Mt = ",max.mt)) +
      theme(plot.title = element_text(size = 24, hjust = 0.5),
            plot.subtitle = element_text(color='red'),
            plot.caption = element_text(color='red'),
            axis.title.x = element_text(size = 20,color='black'),
            axis.title.y = element_text(size = 20,color='black'),
            axis.text.x = element_text(size=12,color='black'),
            axis.text.y = element_text(size = 12,color='black'),
            axis.line = element_line(size = 1),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank())
  )
  dev.off()
  
  # Ribosomal Characterization
  object[['percent.ribo']] <- PercentageFeatureSet(object, pattern = c("RP[SL]\\d+\\w{0,1}\\d*$", 
                                                                       "Rp[sl]\\d+\\w{0,1}\\d*$", 
                                                                       "rp[sl]\\d+\\w{0,1}\\d*$")
                                                   )
  png(file.path(base_save_path, paste(sample.name,'_fp_ribo',tag,'.png',sep="")), width = 500, height = 500)
  print(FeaturePlot(object, c('percent.ribo'), label = T))
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_vln_ribo',tag,'.png',sep="")), width = 500, height = 500)
  print(VlnPlot(object, c('percent.ribo'),pt.size=0.1))
  dev.off()
  
  # Epithelial Characterization
  png(file.path(base_save_path, paste(sample.name,'_fp_c5',tag,'.png',sep="")), width = 800, height = 800)
  print(FeaturePlot(object, c('SFTPC','AGER','DEFB4','LYZ2'), label = T, repel = T))
  dev.off()
  png(file.path(base_save_path, paste(sample.name,'_fp_epi',tag,'.png',sep="")), width = 800, height = 800)
  print(FeaturePlot(object, c('KRT5','SFTPC','HOPX','AQP5'), label = T, repel = T))
  dev.off()
  
  ###### Add further Plots outside the original function ######
  # Titration
  count.test <- seq(100, 1000, by = 100)
  for (i in 1:length(count.test)){
    titrationUMAP(object=object,min.counts=count.test[i],min.features=min.features,max.mt=max.mt, base_save_path=base_save_path, sample.name=sample.name)
  }
  feature.test <- seq(100, 1000, by = 100)
  for (i in 1:length(feature.test)){
    titrationUMAP(object=object,min.counts=min.counts,min.features=feature.test[i],max.mt=max.mt, base_save_path=base_save_path, sample.name=sample.name)
  }
  mt.test <- seq(20, 2, by = -2)
  for (i in 1:length(mt.test)){
    titrationUMAP(object=object,min.counts=min.counts,min.features=min.features,max.mt=mt.test[i], base_save_path=base_save_path, sample.name=sample.name)
  }
  
  ###########################################################

  # Smooth_Scatter - Features
  png(file.path(base_save_path, paste(sample.name,'_smooth_cts',tag,'.png',sep="")), width = 800, height = 800)
  smoothScatter(object$nFeature_RNA, object$percent.mt, 
                main="scatter plot showing the pre-selection filtering gate") + abline(v=c(min.features), h=max.mt, col="red")
  dev.off()
  
  print(smoothScatter(object$nFeature_RNA, object$percent.mt, 
                main="scatter plot showing the pre-selection filtering gate") + abline(v=c(min.features), h=max.mt, col="red"))
  
  # Smooth_Scatter - Counts
  png(file.path(base_save_path, paste(sample.name,'_smooth_fts',tag,'.png',sep="")), width = 800, height = 800)
  
  print(smoothScatter(object$nCount_RNA, object$percent.mt, 
                main="scatter plot showing the pre-selection filtering gate") + abline(v=c(min.counts), h=max.mt, col="red"))
 
  dev.off()
  
  print(smoothScatter(object$nCount_RNA, object$percent.mt, 
                main="scatter plot showing the pre-selection filtering gate") + abline(v=c(min.counts), h=max.mt, col="red"))

  # Print final titration UMAP
  titrationUMAP(object,min.counts,min.features,max.mt, base_save_path=base_save_path, sample.name=sample.name)
  
  }
```


## Setup Chunk for params
```{r}
# Setup Params

# Low Start
min.counts <- 100
min.features <- 100
max.mt <- 20
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')
```


### 1. Control Samples
```{r}
library(parallel)

# get all the Control orig.idents
sample.names <- PPFE_raw@meta.data %>%
  filter(disease.ident == "CTRL") %>%
  pull(orig.ident) %>%
  unique() # Example list of samples


# Low Start
min.counts <- 100
min.features <- 100
max.mt <- 20
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')


# Apply Function as multicore
mclapply(sample.names, function(name) {
  thePipeline(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
}, mc.cores = 15) # Adjust mc.cores based on your system's capabilities and the number of samples.
```

### 2. PPFE-Samples
```{r}
library(parallel)

# get all the Control orig.idents
sample.names <- PPFE_raw@meta.data %>%
  filter(disease.ident == "PPFE") %>%
  pull(orig.ident) %>%
  unique() # Example list of samples


# Low Start
min.counts <- 100
min.features <- 100
max.mt <- 20
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')


# Apply Function as multicore
mclapply(sample.names, function(name) {
  thePipeline(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
}, mc.cores = 21) # Adjust mc.cores based on your system's capabilities and the number of samples.
```

#=============

# PPFE

### PPFE_PPFE001
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE001"
min.counts <- 400
min.features <- 400
max.mt <- 5
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```
```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE001 <- subset(PPFE.list$PPFE_PPFE001, subset = nFeature_RNA > 400 &
                                #nFeature_RNA <  
                                percent.mt < 5 & 
                                #nCount_RNA< 
                                nCount_RNA>400)
```

### PPFE_PPFE002
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE002"
min.counts <- 100
min.features <- 100
max.mt <- 8
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```

```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE002 <- subset(PPFE.list$PPFE_PPFE002, subset = nFeature_RNA > 100 &
                                #nFeature_RNA <  
                                percent.mt < 8 & 
                                #nCount_RNA< 
                                nCount_RNA>100)
```


### PPFE_PPFE003
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE003"
min.counts <- 200
min.features <- 200
max.mt <- 4
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```



```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE003 <- subset(PPFE.list$PPFE_PPFE003, subset = nFeature_RNA > 200 &
                                #nFeature_RNA <  
                                percent.mt < 4 & 
                                #nCount_RNA< 
                                nCount_RNA>200)
```


### PPFE_PPFE004
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE004"
min.counts <- 100
min.features <- 100
max.mt <- 4
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE004 <- subset(PPFE.list$PPFE_PPFE004, subset = nFeature_RNA > 100 &
                                #nFeature_RNA <  
                                percent.mt < 4 & 
                                #nCount_RNA< 
                                nCount_RNA>100)
```


### PPFE_PPFE005
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE005"
min.counts <- 300
min.features <- 300
max.mt <- 4
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE005 <- subset(PPFE.list$PPFE_PPFE005, subset = nFeature_RNA > 300 &
                                #nFeature_RNA <  
                                percent.mt < 4 & 
                                #nCount_RNA< 
                                nCount_RNA>300)
```


### PPFE_PPFE006
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE006"
min.counts <- 300
min.features <- 100
max.mt <- 6
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```

```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE006 <- subset(PPFE.list$PPFE_PPFE006, subset = nFeature_RNA > 100 &
                                #nFeature_RNA <  
                                percent.mt < 6 & 
                                #nCount_RNA< 
                                nCount_RNA>300)
```


### PPFE_PPFE007
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE007"
min.counts <- 300
min.features <- 100
max.mt <- 10
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE007 <- subset(PPFE.list$PPFE_PPFE007, subset = nFeature_RNA > 100 &
                                #nFeature_RNA <  
                                percent.mt < 10 & 
                                #nCount_RNA< 
                                nCount_RNA>300)
```


### PPFE_PPFE008
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE008"
min.counts <- 400
min.features <- 300
max.mt <- 6
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE008 <- subset(PPFE.list$PPFE_PPFE008, subset = nFeature_RNA > 300 &
                                #nFeature_RNA <  
                                percent.mt < 6 & 
                                #nCount_RNA< 
                                nCount_RNA>400)
```


### PPFE_PPFE009
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE009"
min.counts <- 300
min.features <- 100
max.mt <- 10
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE009 <- subset(PPFE.list$PPFE_PPFE009, subset = nFeature_RNA > 100 &
                                #nFeature_RNA <  
                                percent.mt < 10 & 
                                #nCount_RNA< 
                                nCount_RNA>300)
```


### PPFE_PPFE010
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE010"
min.counts <- 300
min.features <- 200
max.mt <- 8
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```

```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE010 <- subset(PPFE.list$PPFE_PPFE010, subset = nFeature_RNA > 200 &
                                #nFeature_RNA <  
                                percent.mt < 8 & 
                                #nCount_RNA< 
                                nCount_RNA>300)
```


### PPFE_PPFE011
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE011"
min.counts <- 400
min.features <- 400
max.mt <- 4
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE011 <- subset(PPFE.list$PPFE_PPFE011, subset = nFeature_RNA > 400 &
                                #nFeature_RNA <  
                                percent.mt < 4 & 
                                #nCount_RNA< 
                                nCount_RNA>400)
```


### PPFE_PPFE012
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE012"
min.counts <- 500
min.features <- 400
max.mt <- 8
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE012 <- subset(PPFE.list$PPFE_PPFE012, subset = nFeature_RNA > 400 &
                                #nFeature_RNA <  
                                percent.mt < 8 & 
                                #nCount_RNA< 
                                nCount_RNA>500)
```


### PPFE_PPFE013
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE013"
min.counts <- 400
min.features <- 400
max.mt <- 8
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE013 <- subset(PPFE.list$PPFE_PPFE013, subset = nFeature_RNA > 400 &
                                #nFeature_RNA <  
                                percent.mt < 8 & 
                                #nCount_RNA< 
                                nCount_RNA>400)
```


### PPFE_PPFE014
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE014"
min.counts <- 500
min.features <- 400
max.mt <- 8
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE014 <- subset(PPFE.list$PPFE_PPFE014, subset = nFeature_RNA > 400 &
                                #nFeature_RNA <  
                                percent.mt < 8 & 
                                #nCount_RNA< 
                                nCount_RNA>500)
```


### PPFE_PPFE015a
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE015a"
min.counts <- 500
min.features <- 400
max.mt <- 4
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE015a <- subset(PPFE.list$PPFE_PPFE015a, subset = nFeature_RNA > 400 &
                                #nFeature_RNA <  
                                percent.mt < 4 & 
                                #nCount_RNA< 
                                nCount_RNA>500)
```


### PPFE_PPFE015b
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE015b"
min.counts <- 400
min.features <- 300
max.mt <- 8
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE015b <- subset(PPFE.list$PPFE_PPFE015b, subset = nFeature_RNA > 300 &
                                #nFeature_RNA <  
                                percent.mt < 8 & 
                                #nCount_RNA< 
                                nCount_RNA>400)
```


### PPFE_PPFE016
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE016"
min.counts <- 500
min.features <- 400
max.mt <- 8
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE016 <- subset(PPFE.list$PPFE_PPFE016, subset = nFeature_RNA > 400 &
                                #nFeature_RNA <  
                                percent.mt < 8 & 
                                #nCount_RNA< 
                                nCount_RNA>500)
```


### PPFE_PPFE017
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE017"
min.counts <- 500
min.features <- 400
max.mt <- 8
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```

```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE017 <- subset(PPFE.list$PPFE_PPFE017, subset = nFeature_RNA > 500 &
                                #nFeature_RNA <  
                                percent.mt < 8 & 
                                #nCount_RNA< 
                                nCount_RNA>400)
```


### PPFE_PPFE018
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE018"
min.counts <- 500
min.features <- 400
max.mt <- 10
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE018 <- subset(PPFE.list$PPFE_PPFE018, subset = nFeature_RNA > 400 &
                                #nFeature_RNA <  
                                percent.mt < 10 & 
                                #nCount_RNA< 
                                nCount_RNA>500)
```


### PPFE_PPFE019
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE019"
min.counts <- 500
min.features <- 400
max.mt <- 10
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE019 <- subset(PPFE.list$PPFE_PPFE019, subset = nFeature_RNA > 400 &
                                #nFeature_RNA <  
                                percent.mt < 10 & 
                                #nCount_RNA< 
                                nCount_RNA>500)
```



### PPFE_PPFE020
```{r, fig.height=3, fig.width=4}
# Low Start
name = "PPFE_PPFE020"
min.counts <- 300
min.features <- 150
max.mt <- 20
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$PPFE_PPFE020 <- subset(PPFE.list$PPFE_PPFE020, subset = nFeature_RNA > 150 &
                                #nFeature_RNA <  
                                percent.mt < 20 & 
                                #nCount_RNA< 
                                nCount_RNA>300)
```






# CTRL

### CTRL_CTRL002
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_CTRL002"
min.counts <- 150
min.features <- 150
max.mt <- 5
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_CTRL002 <- subset(PPFE.list$CTRL_CTRL002, subset = nFeature_RNA > 150 & 
                                  #nFeature_RNA < 5000 & 
                                  percent.mt < 5 & 
                                  #nCount_RNA<10000 & 
                                  nCount_RNA>150)
```


### CTRL_CTRL007
```{r}
# Low Start
name = "CTRL_CTRL007"
min.counts <- 150
min.features <- 150
max.mt <- 5
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```



```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_CTRL007 <- subset(PPFE.list$CTRL_CTRL007, subset = nFeature_RNA > 150 &
                                  #nFeature_RNA < 4000 & 
                                  percent.mt < 5 & 
                                  #nCount_RNA< 8000 &
                                  nCount_RNA>150)
```

### CTRL_GLR632
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_GLR632"
min.counts <- 150
min.features <- 150
max.mt <- 15
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```

```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_GLR632 <- subset(PPFE.list$CTRL_GLR632, subset = nFeature_RNA > 150 &
                                 #nFeature_RNA < 800 & 
                                 percent.mt < 15 & 
                                 #nCount_RNA<1300 & 
                                 nCount_RNA>150)
```


### CTRL_CTR051
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_CTR051"
min.counts <- 150
min.features <- 150
max.mt <- 10
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_CTRL007 <- subset(PPFE.list$CTRL_CTRL007, subset = nFeature_RNA > 150 &
                                  #nFeature_RNA < 4000 & 
                                  percent.mt < 10 & 
                                  #nCount_RNA< 8000 &
                                  nCount_RNA>150)
```

### CTRL_CTR071
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_CTR071"
min.counts <- 150
min.features <- 150
max.mt <- 10
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_CTR071 <- subset(PPFE.list$CTRL_CTR071, subset = nFeature_RNA > 150 &
                                 #nFeature_RNA < 800 & 
                                 percent.mt < 10 & 
                                 #nCount_RNA<1300 & 
                                 nCount_RNA>150)
```



### CTRL_GLR635
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_GLR635"
min.counts <- 150
min.features <- 150
max.mt <- 7
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_GLR635 <- subset(PPFE.list$CTRL_GLR635, subset = nFeature_RNA > 150 & 
                                 #nFeature_RNA < 1300 & 
                                 percent.mt < 7 & 
                                 #nCount_RNA< 2000 & 
                                 nCount_RNA>150)
```


### CTRL_GLE639
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_GLE639"
min.counts <- 150
min.features <- 150
max.mt <- 5
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```

```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_GLE639 <- subset(PPFE.list$CTRL_GLE639, subset = nFeature_RNA > 150 & 
                                 #nFeature_RNA < 2000 &
                                 percent.mt < 5 & 
                                 #nCount_RNA< 4000 & 
                                 nCount_RNA>150)
```




### CTRL_GLR609
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_GLR609"
min.counts <- 150
min.features <- 150
max.mt <- 3
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_GLR609 <- subset(PPFE.list$CTRL_GLR609, subset = nFeature_RNA > 150 &
                                 #nFeature_RNA < 3500 &
                                 percent.mt < 3 & 
                                 #nCount_RNA< 7000 & 
                                 nCount_RNA>150)
```




### CTRL_GLR725
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_GLR725"
min.counts <- 150
min.features <- 150
max.mt <- 5
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```

```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_GLR725 <- subset(PPFE.list$CTRL_GLR725, subset = nFeature_RNA > 150 & 
                                 #nFeature_RNA < 1500 & 
                                 percent.mt < 5 & 
                                 #nCount_RNA< 2500 &
                                 nCount_RNA>150)
```



### CTRL_CTR048
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_CTR048"
min.counts <- 150
min.features <- 100
max.mt <- 5
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_CTR048 <- subset(PPFE.list$CTRL_CTR048, subset = nFeature_RNA > 100 & 
                                 #nFeature_RNA < 1000 &
                                 percent.mt < 5 & 
                                 #nCount_RNA< 1500 & 
                                 nCount_RNA>150)
```


### CTRL_CTR068
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_CTR068"
min.counts <- 150
min.features <- 100
max.mt <- 2
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_CTR068 <- subset(PPFE.list$CTRL_CTR068, subset = nFeature_RNA > 100 &
                                 #nFeature_RNA < 1500 & 
                                 percent.mt < 2 &
                                 #nCount_RNA< 2250 &
                                 nCount_RNA>150)
```


### CTRL_CTR069
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_CTR069"
min.counts <- 150
min.features <- 150
max.mt <- 2
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_CTR069 <- subset(PPFE.list$CTRL_CTR069, subset = nFeature_RNA > 150 & 
                                 #nFeature_RNA < 1200 & 
                                 percent.mt < 2 &
                                 #nCount_RNA< 2000 & 
                                 nCount_RNA>150)
```


### CTRL_CTR070
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_CTR070"
min.counts <- 150
min.features <- 150
max.mt <- 3
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_CTR070 <- subset(PPFE.list$CTRL_CTR070, subset = nFeature_RNA > 150 & 
                                 #nFeature_RNA < 1500 & 
                                 percent.mt < 3 &
                                 #nCount_RNA< 2000 &
                                 nCount_RNA>150)
```



### CTRL_GLE822
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_GLE822"
min.counts <- 150
min.features <- 150
max.mt <- 3
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_GLE822 <- subset(PPFE.list$CTRL_GLE822, subset = nFeature_RNA > 150 & 
                                 #nFeature_RNA < 2000 & 
                                 percent.mt < 3 & 
                                 #nCount_RNA<4000 & 
                                 nCount_RNA>150)
```


### CTRL_GLE891
```{r, fig.height=3, fig.width=4}
# Low Start
name = "CTRL_GLE891"
min.counts <- 150
min.features <- 150
max.mt <- 3
tag <- paste('.min.ct',min.counts,'min.ft',min.features,'max.mt',max.mt,sep='.')

thePipeline_final(sample.name=name, min.counts=min.counts, min.features=min.features, max.mt=max.mt, tag=tag, seurat.data=PPFE.list)
```


```{r, fig.height=3, fig.width=7}
# Subset the dataset
PPFE.list$CTRL_GLE891 <- subset(PPFE.list$CTRL_GLE891, subset = nFeature_RNA > 150 & 
                                 #nFeature_RNA < 2000 & 
                                 percent.mt < 3 & 
                                 #nCount_RNA<4000 & 
                                 nCount_RNA>150)
```


#====================================

# Doublet Finding
```{r}
for (i in samples) {
  PPFE.list[[i]] <- RunCellQC(PPFE.list[[i]], assay = "RNA", qc_metrics = c("doublets"))
  }
```

#=============================

# Prepare for  RPCA Integration

## Normalize + HVF 
```{r}
PPFE.list <- lapply(X = PPFE.list, FUN = function(x) {
    x <- NormalizeData(x, verbose = FALSE)
    x <- FindVariableFeatures(x, verbose = FALSE, nfeatures = 2000)
})
```

## Scale and PCA
```{r}
features <- SelectIntegrationFeatures(object.list = PPFE.list, nfeatures = 2000)
features <- features[!grepl("MT-", features)]
```

```{r}
PPFE.list <- lapply(X = PPFE.list, FUN = function(x) {
    x <- ScaleData(x, features = features, vars.to.regress = c("nCount_RNA"), verbose = FALSE)
    x <- RunPCA(x, features = features, verbose = FALSE)
})
```

```{r}
# find smallest dataset
min(table(PPFE_metadata$orig.ident))
```

```{r}
saveRDS(PPFE.list, "PPFE_list_Batch1_Han_03.10.2024.rds")
```